From dbdd9ffea81d9db46fb88b5eba828f2ad080d388 Mon Sep 17 00:00:00 2001
From: Sergey Kandaurov <pluknet@nginx.com>
Date: Tue, 13 Aug 2019 15:43:32 +0300
Subject: [PATCH] HTTP/2: reject zero length headers with PROTOCOL_ERROR.

Fixed uncontrolled memory growth if peer sends a stream of
headers with a 0-length header name and 0-length header value.
Fix is to reject headers with zero name length.
---
 src/http/v2/ngx_http_v2.c | 12 ++++++++----
 1 file changed, 8 insertions(+), 4 deletions(-)

Index: nginx-1.14.0/src/http/v2/ngx_http_v2.c
===================================================================
--- nginx-1.14.0.orig/src/http/v2/ngx_http_v2.c	2019-08-14 14:44:36.239373498 -0400
+++ nginx-1.14.0/src/http/v2/ngx_http_v2.c	2019-08-14 14:44:36.239373498 -0400
@@ -1549,6 +1549,14 @@ ngx_http_v2_state_process_header(ngx_htt
         header->name.len = h2c->state.field_end - h2c->state.field_start;
         header->name.data = h2c->state.field_start;
 
+        if (header->name.len == 0) {
+            ngx_log_error(NGX_LOG_INFO, h2c->connection->log, 0,
+                          "client sent zero header name length");
+
+            return ngx_http_v2_connection_error(h2c,
+                                                NGX_HTTP_V2_PROTOCOL_ERROR);
+        }
+
         return ngx_http_v2_state_field_len(h2c, pos, end);
     }
 
@@ -3259,10 +3267,6 @@ ngx_http_v2_validate_header(ngx_http_req
     ngx_uint_t                 i;
     ngx_http_core_srv_conf_t  *cscf;
 
-    if (header->name.len == 0) {
-        return NGX_ERROR;
-    }
-
     r->invalid_header = 0;
 
     cscf = ngx_http_get_module_srv_conf(r, ngx_http_core_module);
